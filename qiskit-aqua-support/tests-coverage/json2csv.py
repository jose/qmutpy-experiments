#!/usr/bin/env python
#
# ------------------------------------------------------------------------------
# This script converts a JSON file generated by [Coverage](https://coverage.readthedocs.io/en/coverage-5.5/)
# into a CSV file.
#
# Usage:
# json2csv.py <json file path> <csv file path>
#
# Requirements:
#   - Python >= 3.6.8
# ------------------------------------------------------------------------------

import os
import sys
import csv
import json

if sys.version_info < (3, 6, 8):
    print('The json2csv.py script requires Python >= 3.6.8!')
    exit(1)

if len(sys.argv) != 3:
    print("Usage:\njson2csv.py <json file path> <csv file path>")
    exit(1)

json_file = os.path.abspath(sys.argv[1])
csv_file  = os.path.abspath(sys.argv[2])

fieldnames = [
    'file', 'line', 'covered', 'excluded'
]

with open(csv_file, 'w', newline='') as csv_file_output:
    csv_output = csv.DictWriter(csv_file_output, fieldnames=fieldnames)
    csv_output.writeheader()

    with open(json_file) as json_file_input:
        data = json.load(json_file_input)

        files = data['files']
        assert len(files) > 0
        for file in files:
            executed_lines = files[file]['executed_lines']
            missing_lines  = files[file]['missing_lines']
            excluded_lines = files[file]['excluded_lines']
            assert len(executed_lines) + len(missing_lines) + len(excluded_lines) > 0

            for line in executed_lines:
                row = {'file': file, 'line': line, 'covered': 1, 'excluded': 0}
                csv_output.writerow(row)
            for line in missing_lines:
                row = {'file': file, 'line': line, 'covered': 0, 'excluded': 0}
                csv_output.writerow(row)
            for line in excluded_lines:
                row = {'file': file, 'line': line, 'covered': 0, 'excluded': 1}
                csv_output.writerow(row)

# EOF
